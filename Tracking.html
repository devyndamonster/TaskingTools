<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Text Highlighter</title>
  <style>
    #editor-container {
      position: relative;
      width: 100%;
      height: 70vh;
      margin: 20px auto;
      border: 1px solid #ccc;
    }
    #highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: black;
      pointer-events: none;  /* allows clicks to fall through to the textarea */
      font-family: monospace;
      font-size: 16px;
    }
    #editor {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px;
      border: none;
      background: transparent;
      color: transparent;       /* Hide the native text */
      caret-color: black;        /* Keep the caret visible */
      resize: none;
      overflow: auto;
      z-index: 1;
      outline: none;
      font-family: monospace;
      font-size: 16px;
    }
    #summary-container {
      position: relative;
      width: 100%;
      height: 30vh;
      margin: 20px auto;
      border: 1px solid #ccc;
    }
    #summary {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px;
      font-family: monospace;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="editor-container">
    <div id="highlight"></div>
    <textarea id="editor" spellcheck="false" oninput="updateHighlight()"></textarea>
  </div>
  <div id="summary-container">
    <div id="summary">Hello</div>
  </div>

  <script>
    // Escapes HTML special characters so the text can be safely injected into the page.
    function escapeHtml(text) {
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Updates the highlight div to display the current text with "#Red" highlighted in red.
    function updateHighlight() {
      var text = document.getElementById('editor').value;

      if(text == ""){
        text = localStorage.getItem('editorText');
      }

      var lines = text.split('\n');
      lines = lines.map(line => {
        var segments = line.split(" - ");

        if(segments.length == 1){
          //Get current date in format "11:00 AM"
          var date = new Date();
          var options = { hour: '2-digit', minute: '2-digit', hour12: true };
          var time = date.toLocaleTimeString([], options);

          return `${time} - `;
        }

        return line
      })

      var summaryCollection = {};
      var previousTime = null;
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var segments = line.split(" - ");
        var timestamp = getDateFromString(segments[0]);

        var deltaTimeMinutes = 0;
        if (previousTime) {
          var diffMiliseconds = timestamp - previousTime;
          deltaTimeMinutes = Math.floor(diffMiliseconds / (1000 * 60));
        }
        previousTime = timestamp;

        var keyWords = getAllKeyWords(segments[1]);
        for (var word of keyWords) {
          if (word in summaryCollection) {
            summaryCollection[word] += deltaTimeMinutes;
          } else {
            summaryCollection[word] = deltaTimeMinutes;
          }
        }
      }

      var summaryText = "Summary:\n";
      for (var key in summaryCollection) {
        var minutes = summaryCollection[key];
        var hours = Math.floor(minutes / 60);
        var remainingMinutes = minutes % 60;
        summaryText += `${key}: ${hours}h ${remainingMinutes}m\n`;
      }

      var editorText = lines.join('\n');
      var highlightText = escapeHtml(editorText);

      lines = highlightText.split('\n');
      lines = lines.map(line => {
        var keyWords = getAllKeyWords(line);
        for(var word of keyWords){
          line = line.replace(word, `<span style='color: red;'>${word}</span>`);
        }
        return line;
      })
      
      highlightText = lines.join('\n');

      document.getElementById('editor').value = editorText;
      document.getElementById('highlight').innerHTML = highlightText;
      document.getElementById('summary').innerText = summaryText;

      //Save to local storage
      localStorage.setItem('editorText', editorText);
    }

    function getAllKeyWords(text) {
      var words = text.split(" ");
      var keyWords = words.filter(word => word.startsWith("#"));
      return keyWords;
    }

    /***
     * Processes string with format "11:00 AM" to Date, or null if not valid
     * @param {string} text - The input text.
     * @returns {Date | null} - The resulting date, assuming it is the current day
     */
    function getDateFromString(text){
      try{
        var date = new Date();
        var time = text.split(" ")[0];
        var ampm = text.split(" ")[1];
        var hour = parseInt(time.split(":")[0]);
        var minute = parseInt(time.split(":")[1]);
        if(ampm == "PM" && hour != 12){
          hour += 12;
        }
        if(ampm == "AM" && hour == 12){
          hour = 0;
        }
        date.setHours(hour);
        date.setMinutes(minute);
        return date;
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    // Initialize the highlighted view on page load.
    updateHighlight();
  </script>
</body>
</html>
